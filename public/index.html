<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Basic Razorpay Payment Test</title>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <link rel="stylesheet" href="styles.css">
</head>
<body>

    <header class="navbar">
        <div class="container navbar-container">
            <div href="https://lushaitech.com" class="app-info">
                <img src="/lushai_logo.svg" alt="App Logo" class="app-logo">
            </div>
            
        </div>
    </header>

    <main class="main-content">
        <div class="container form-container">
            <h1>Make a Payment</h1>
            <form id="paymentForm">
                <label for="amount">Amount (INR):</label>
                <input type="number" id="amount" min="1" required>
                <small>Enter amount in Rupees </small>
                <br>
                <label for="description">Description:</label>
                <input type="text" id="description" placeholder="Description" required>
                <br>
                <label for="name">Name:</label>
                <input type="text" id="name" placeholder="Enter name here" required>
                <br>
                <label for="phone">Phone:</label>
                <input type="tel" id="phone" placeholder="e.g., 9876543210 (10 digits)" pattern="[6-9]{1}[0-9]{9}" title="Please enter a valid 10-digit Indian phone number starting with 6, 7, 8, or 9." required>
                <br>
                <label for="email">Email:</label>
                <input type="email" id="email" placeholder="Enter email" required>
                <br>
                <label for="grade">Enter your class:</label>
                <select name="grade" id="grade">
                    <option value="9">IX</option>
                    <option value="10">X</option>
                    <option value="BA">B.A</option>
                    <option value="BSc">B.Sc</option>
                </select>
                <br>
                <label>Subjects:</label>
                <div class="checkbox-group" style="display: block;">
                    <div class="checkbox-item" style="display: flex; align-items: center; margin-bottom: 0.5em;">
                        <input type="checkbox" id="maths" name="subjects" value="Mathematics" style="margin-right: 0.5em;">
                        <label for="maths" style="margin: 0;">Mathematics</label>
                    </div>
                    <div class="checkbox-item" style="display: flex; align-items: center; margin-bottom: 0.5em;">
                        <input type="checkbox" id="science" name="subjects" value="Science" style="margin-right: 0.5em;">
                        <label for="science" style="margin: 0;">Science</label>
                    </div>
                    <div class="checkbox-item" style="display: flex; align-items: center; margin-bottom: 0.5em;">
                        <input type="checkbox" id="chemistry" name="subjects" value="English" style="margin-right: 0.5em;">
                        <label for="chemistry" style="margin: 0;">Chemistry</label>
                    </div>
                </div>
                <br>
                <button type="submit">Pay Now</button>
            </form>
            <div id="paymentStatus"></div>
            <!-- Modal for receipt download -->
            <div id="receiptModal" class="modal" style="display:none; position:fixed; z-index:1000; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,0.4); justify-content:center; align-items:center;">
                <div style="background:#fff; padding:2rem; border-radius:8px; max-width:90vw; max-height:90vh; text-align:center;">
                    <h2>Payment Successful!</h2>
                    <p>Your payment was verified and recorded.<br>A receipt has been sent to your email.</p>
                    <button id="openReceiptBtn" style="margin-top:1rem; padding:0.5rem 1.5rem; font-size:1rem;">Open Receipt PDF</button>
                    <br><br>
                    <button id="closeModalBtn" style="padding:0.3rem 1rem;">Close</button>
                </div>
            </div>
        </div>
    </main>

    <footer class="footer">
        <div class="container footer-container">
            <p>&copy; 2025 LushaiTech. All rights reserved.</p>
            
        </div>
    </footer>
  <script>
        const BACKEND_URL = 'http://localhost:3000'; // Replace with your backend URL
        const RAZORPAY_KEY_ID = 'rzp_test_JuPxU5cqhKNUhZ'; // Replace with your actual Razorpay Key ID

       
        document.getElementById('paymentForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const amountInRupees = parseFloat(document.getElementById('amount').value);
            const subjectCheckboxes = document.querySelectorAll('input[name="subjects"]:checked');
            const subjects = Array.from(subjectCheckboxes).map(cb => cb.value);
            console.log('Selected subjects:', subjects);
            // Razorpay expects amount in the smallest currency unit (e.g., paise for INR)
            const amountInPaise = Math.round(amountInRupees * 100);
            const description = document.getElementById('description').value;
            const grade = document.getElementById('grade').value;
            const name = document.getElementById('name').value;
            const subjectsString = subjects.length > 0 ? (', Subjects: ' + subjects.join(', ')) : '';
            const phone = document.getElementById('phone').value;
            const email = document.getElementById('email').value;
            // Collect checked subjects into an array
            
            

            // console.log('name------->',name)
            const paymentStatusDiv = document.getElementById('paymentStatus');
            paymentStatusDiv.className = '';
            paymentStatusDiv.textContent = 'Initiating payment... Please wait.';

            try {
                // 1. Call backend to create Razorpay Order
                const createOrderResponse = await fetch(`${BACKEND_URL}/api/create-payment`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        amount: amountInPaise,
                        description: description,
                        name:name,
                        subjects: subjects,
                        grade: grade,
                    })
                });

                if (!createOrderResponse.ok) {
                    const errorData = await createOrderResponse.json();
                    throw new Error(errorData.error || 'Failed to create order on backend.');
                }

                const orderData = await createOrderResponse.json();
                const razorpayOrderId = orderData.id; 
                // console.log("NAME --->",name)

                // 2. Configure Razorpay Checkout options
                const options = {
                    key: RAZORPAY_KEY_ID,
                    amount: amountInPaise,
                    currency: 'INR',      
                    name: 'LushAITech', 
                    description: description,
                    order_id: razorpayOrderId, 
                    handler: async function (response) {
                        // This function is called on successful payment from Razorpay Checkout
                        paymentStatusDiv.className = '';
                        paymentStatusDiv.textContent = 'Payment successful! Verifying with backend...';

                        try {
                            // 3. Send payment details to backend for verification
                            const verifyResponse = await fetch(`${BACKEND_URL}/api/verify-payment`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    razorpay_order_id: response.razorpay_order_id,
                                    razorpay_payment_id: response.razorpay_payment_id,
                                    razorpay_signature: response.razorpay_signature,
                                    name: name,
                                    subjects: subjects,
                                })
                            });

                            // Try to open PDF if response is PDF, else handle JSON
                            const contentType = verifyResponse.headers.get('Content-Type');
                            if (verifyResponse.ok && contentType && contentType.includes('application/pdf')) {
                                // Get PDF as blob and show modal with button to open in new tab
                                const pdfBlob = await verifyResponse.blob();
                                const pdfUrl = URL.createObjectURL(pdfBlob);
                                paymentStatusDiv.className = 'success';
                                paymentStatusDiv.textContent = 'Payment successfully verified and recorded!';

                                // Show modal
                                const modal = document.getElementById('receiptModal');
                                modal.style.display = 'flex';
                                // Button to open PDF
                                const openBtn = document.getElementById('openReceiptBtn');
                                openBtn.onclick = (event) => {
                                    event.preventDefault();
                                    event.stopPropagation();
                                    window.open(pdfUrl, '_blank');
                                };
                                // Button to close modal
                                const closeBtn = document.getElementById('closeModalBtn');
                                closeBtn.onclick = (event) => {
                                    event.preventDefault();
                                    event.stopPropagation();
                                    modal.style.display = 'none';
                                    paymentStatusDiv.textContent = '';
                                    paymentStatusDiv.className = '';
                                };
                            } else {
                                // Fallback: handle JSON response
                                const verifyResult = await verifyResponse.json();
                                if (verifyResponse.ok && verifyResult.success) {
                                    paymentStatusDiv.className = 'success';
                                    paymentStatusDiv.textContent = 'Payment successfully verified and recorded!';
                                    // Show modal (no PDF)
                                    const modal = document.getElementById('receiptModal');
                                    modal.style.display = 'flex';
                                    const openBtn = document.getElementById('openReceiptBtn');
                                    openBtn.onclick = () => {
                                        modal.style.display = 'none';
                                    };
                                    openBtn.textContent = 'OK';
                                    // Hide close button if only OK
                                    document.getElementById('closeModalBtn').style.display = 'none';
                                } else {
                                    throw new Error(verifyResult.error || 'Payment verification failed on backend.');
                                }
                            }
                        } catch (error) {
                            console.error('Payment verification error:', error);
                            paymentStatusDiv.className = 'error';
                            paymentStatusDiv.textContent = `Payment verification failed: ${error.message}`;
                            // alert(`Payment verification failed: ${error.message}`);
                        }
                    },
                    prefill: {
                        // Optional: prefill user details if you have them
                        name: name,
                        email: email,
                        contact: phone,
                    },
                    notes: {
                        'app_description': "LushAi",
                        name: name,
                        email: email,
                        phone: phone,
                        grade: grade,
                        subjects: subjects.join ? subjects.join(', ') : subjects // Ensure subjects is a string for Razorpay notes
                    },
                    theme: {
                        "color": "#3399CC" // Customize checkout theme
                    }
                };

                const rzp = new Razorpay(options);
                rzp.on('payment.failed', function (response) {
                    console.error('Payment failed:', response.error);
                    paymentStatusDiv.className = 'error';
                    paymentStatusDiv.textContent = `Payment failed: ${response.error.description || 'Unknown error'}`;
                    alert(`Payment failed: ${response.error.description}`);

                });

                rzp.open(); 

            } catch (error) {
                console.error('Error initiating payment:', error);
                paymentStatusDiv.className = 'error';
                paymentStatusDiv.textContent = `Error: ${error.message}`;
                // alert(`Error initiating payment: ${error.message}`);
            }
        });
    </script>
    </body>
</html>